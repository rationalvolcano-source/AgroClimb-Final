You are editing my existing full-stack project AgroClimb.
Tech stack:

Frontend: React + Vite + TypeScript, router = wouter, in client/

Backend: Node + Express + TypeScript in server/

DB: Postgres (Neon)

Auth provider I’m integrating now: Clerk (React + Express SDKs)

I already set the env vars VITE_CLERK_PUBLISHABLE_KEY and CLERK_SECRET_KEY in the Replit Secrets panel. Don’t change secrets, just use them.

Your task: implement Clerk auth integration (frontend + backend) exactly as specified below.

1) Install required packages

Run these from the project root:

npm install @clerk/clerk-react @clerk/express

2) FRONTEND CHANGES (React + Vite + wouter) [Step 3]

All frontend code lives under client/. Make these edits:

2.1 Wrap the app with <ClerkProvider> in client/src/main.tsx

Ensure main.tsx imports ClerkProvider from @clerk/clerk-react.

Wrap <App /> with <ClerkProvider> using the env var VITE_CLERK_PUBLISHABLE_KEY.

Final file should look like (adjust only imports that differ; keep existing CSS import):

import React from "react";
import ReactDOM from "react-dom/client";
import App from "./App.tsx";
import "./index.css";
import { ClerkProvider } from "@clerk/clerk-react";

const PUBLISHABLE_KEY = import.meta.env.VITE_CLERK_PUBLISHABLE_KEY;

if (!PUBLISHABLE_KEY) {
  throw new Error("Missing VITE_CLERK_PUBLISHABLE_KEY");
}

ReactDOM.createRoot(document.getElementById("root") as HTMLElement).render(
  <React.StrictMode>
    <ClerkProvider publishableKey={PUBLISHABLE_KEY}>
      <App />
    </ClerkProvider>
  </React.StrictMode>
);

2.2 Create sign-in and sign-up pages

Create client/src/pages/SignInPage.tsx:

import { SignIn } from "@clerk/clerk-react";

export function SignInPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-950">
      <SignIn
        path="/sign-in"
        routing="path"
        signUpUrl="/sign-up"
        afterSignInUrl="/"
      />
    </div>
  );
}


Create client/src/pages/SignUpPage.tsx:

import { SignUp } from "@clerk/clerk-react";

export function SignUpPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-950">
      <SignUp
        path="/sign-up"
        routing="path"
        signInUrl="/sign-in"
        afterSignUpUrl="/"
      />
    </div>
  );
}

2.3 Create RequireAuth wrapper component

Create client/src/components/RequireAuth.tsx:

import { ReactNode } from "react";
import { SignedIn, SignedOut, RedirectToSignIn } from "@clerk/clerk-react";

interface RequireAuthProps {
  children: ReactNode;
}

export function RequireAuth({ children }: RequireAuthProps) {
  return (
    <>
      <SignedIn>{children}</SignedIn>
      <SignedOut>
        <RedirectToSignIn />
      </SignedOut>
    </>
  );
}

2.4 Wire Clerk into routing in client/src/App.tsx

This app uses wouter with <Switch> and <Route>.

Import the new pages and wrapper at the top of App.tsx:

import { Route, Switch } from "wouter";
import { SignInPage } from "./pages/SignInPage";
import { SignUpPage } from "./pages/SignUpPage";
import { RequireAuth } from "./components/RequireAuth";


(Keep all existing imports for other pages like DigitalSkillsPage, AlumniWebinarsPage, DailyNewsPage, etc.)

In the <Switch> where routes are declared:

Leave existing public routes as they are (/, /books, /career-quiz, /careers/:path, /interview-prep, etc.).

Wrap these protected routes with <RequireAuth>:

<Route path="/digital-skills">
  <RequireAuth>
    <DigitalSkillsPage />
  </RequireAuth>
</Route>

<Route path="/alumni-webinars">
  <RequireAuth>
    <AlumniWebinarsPage />
  </RequireAuth>
</Route>

<Route path="/daily-news">
  <RequireAuth>
    <DailyNewsPage />
  </RequireAuth>
</Route>


Register the sign-in / sign-up routes:

<Route path="/sign-in" component={SignInPage} />
<Route path="/sign-up" component={SignUpPage} />


Make sure these are inside the <Switch> with the rest of the routes.

2.5 Add sign-in button and user menu in client/src/components/Nav.tsx

At the top of Nav.tsx, import Clerk UI helpers:

import {
  SignedIn,
  SignedOut,
  SignInButton,
  UserButton,
} from "@clerk/clerk-react";


In the section of the navbar where action buttons / CTAs appear (usually right side), add:

<SignedOut>
  <SignInButton mode="modal" afterSignInUrl="/">
    <button className="px-3 py-1 rounded-lg bg-emerald-500 text-sm font-medium">
      Sign in
    </button>
  </SignInButton>
</SignedOut>

<SignedIn>
  <UserButton afterSignOutUrl="/" />
</SignedIn>


Ensure TypeScript compiles with no type errors after these edits.

3) BACKEND CHANGES (Express + TypeScript) [Step 4]

Backend code lives in server/. There is an Express app with endpoints including:

POST /api/enroll

GET /api/enrollments

We want to:

Add Clerk middleware globally.

Protect /api/enroll and /api/enrollments with requireAuth().

Use getAuth(req).userId as the authenticated user identifier.

Stop using Replit Auth routes/middleware if any are still active.

3.1 Import Clerk middleware in the main server file

Open the main Express entry file (likely server/index.ts or similar — the one that has const app = express() and app.listen).

Add this import near the top:

import { clerkMiddleware, requireAuth, getAuth } from "@clerk/express";


After const app = express(); and any app.use(express.json()) / CORS middleware, add:

app.use(clerkMiddleware());


This allows Clerk to read the session from cookies on every request.

3.2 Protect /api/enroll route

Find the existing POST /api/enroll handler.
Wrap it with requireAuth() and use getAuth(req) to get userId.

Example structure (adapt to existing logic, but keep the auth part exactly):

app.post("/api/enroll", requireAuth(), async (req, res) => {
  try {
    const { userId } = getAuth(req);

    if (!userId) {
      return res.status(401).json({ error: "Not authenticated" });
    }

    // Existing enrollment logic goes here.
    // Use `userId` as the authenticated user identifier,
    // e.g. insert into enrollments table: clerk_user_id = userId

  } catch (err) {
    console.error("Error in /api/enroll:", err);
    res.status(500).json({ error: "Internal server error" });
  }
});

3.3 Protect /api/enrollments route

Similarly, find the GET /api/enrollments handler and wrap it:

app.get("/api/enrollments", requireAuth(), async (req, res) => {
  try {
    const { userId } = getAuth(req);

    if (!userId) {
      return res.status(401).json({ error: "Not authenticated" });
    }

    // Fetch enrollments for this user only.
    // Example (pseudocode):
    // const rows = await db.query("SELECT * FROM enrollments WHERE clerk_user_id = $1", [userId]);
    // res.json(rows);

  } catch (err) {
    console.error("Error in /api/enrollments:", err);
    res.status(500).json({ error: "Internal server error" });
  }
});


Keep the existing DB functions, just scope them to userId.

3.4 Remove / disable old Replit Auth routes/middleware

If there is a file like server/replitAuth.ts and any app.use(...) or routes such as:

/api/login

/api/callback

/api/logout

/api/auth/user

then comment them out or delete those route definitions, so they are no longer used.

AgroClimb should rely solely on Clerk auth now:

Frontend: @clerk/clerk-react

Backend: @clerk/express

4) Final sanity checks

Ensure TypeScript builds without errors on both client and server.

Run the dev server and confirm:

/sign-in renders the Clerk sign-in UI with a “Continue with Google” button.

Visiting /digital-skills, /alumni-webinars, or /daily-news while signed out redirects to /sign-in.

After signing in with Google, these protected routes are accessible.

Please implement all of the above changes now. Do not refactor unrelated code; focus only on adding Clerk integration as described.